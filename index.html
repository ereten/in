<!DOCTYPE html>
<!--
Created using JS Bin
http://jsbin.com

Copyright (c) 2025 by anonymous (http://jsbin.com/vemijinude/1/edit)

Released under the MIT license: http://jsbin.mit-license.org
-->
<meta name="robots" content="noindex">
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VNM â€” Virtual Nations Map</title>
  <link rel="icon" type="image/png" href="favicon.png">
<style>
  html,body{height:100%}
  body{margin:0;background:#0b1220;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Apple SD Gothic Neo,sans-serif}
  .container{max-width:960px;margin:32px auto;padding:0 16px}
  .card{background:#0e1726;border:1px solid #1f2a44;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.3);overflow:hidden}
  .card-hd{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid #1f2a44}
  .title{font-weight:800;font-size:20px}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:#4338ca;color:#fff;font-weight:700;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .row{display:flex;gap:16px;padding:16px 20px}
  .left{flex:1}
  .right{width:280px}
  .panel{background:#0b1323;border:1px solid #1f2a44;border-radius:12px;padding:12px}
  .panel h3{margin:.25rem 0 .5rem;font-size:14px;color:#9fb0d3}
  .toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:8px 0 10px}
  .seg{display:flex;background:#0b1323;border:1px solid #1f2a44;border-radius:12px;overflow:hidden}
  .seg button{padding:8px 10px;background:transparent;border:0;color:#cbd5e1;font-weight:700;cursor:pointer}
  .seg button.active{background:#1b254b}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid #1f2a44;background:#0b1323}
  .hint{font-size:12px;color:#93a4c7}
  .canvas-wrap{position:relative;background:#0a0f1e;border:1px solid #1f2a44;border-radius:12px;padding:8px}
  #board{display:block;width:100%;height:420px;border-radius:10px;background:#0a0f1e;touch-action:none}
  .status{font-size:12px;color:#8fbf8f}
  .feed-card{background:#0b1323;border:1px solid #1f2a44;border-radius:12px;padding:12px;margin-top:16px}
  .input, select{width:100%;background:#0b1323;border:1px solid #1f2a44;border-radius:12px;color:#dbe5ff;padding:10px}
  textarea.input{min-height:140px;resize:vertical}

  .nation-list{position:absolute;right:12px;bottom:12px;background:rgba(10,15,30,.85);
    border:1px solid #1f2a44;border-radius:10px;padding:8px 10px;backdrop-filter:blur(4px);max-height:160px;overflow:auto}
  .nation-row{display:flex;align-items:center;gap:8px;font-size:12px;margin:4px 0}
  .swatch{width:14px;height:14px;border-radius:3px;border:1px solid rgba(255,255,255,.2)}

  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(92vw,520px);background:#0e1726;border:1px solid #1f2a44;border-radius:16px;padding:16px}
  .modal h3{margin-top:0;font-size:16px}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .badge{border:1px solid #1f2a44;border-radius:999px;padding:3px 8px;font-size:12px;color:#9fb0d3}
  .taken-list{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px;margin-top:8px}
  .taken-item{display:flex;align-items:center;gap:8px;font-size:12px}

  /* ì•„ë°”íƒ€(êµ­ê¸°) */
  .avatar{width:24px;height:24px;border-radius:999px;object-fit:cover;border:1px solid rgba(255,255,255,.2)}
  .post-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
  .cmt-item{display:flex;gap:8px;align-items:flex-start;border-top:1px solid #1f2a44;padding-top:8px;margin-top:8px}

  /* ìš°ì¸¡ íŒ¨ë„ì˜ ë¦¬ìŠ¤íŠ¸ */
  .mini-list{display:grid;gap:8px;max-height:200px;overflow:auto}
  .mini-item{font-size:12px;line-height:1.35;border:1px solid #1f2a44;background:#0b1323;border-radius:8px;padding:8px}
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="card-hd">
        <div class="title">ğŸ›ï¸ VNM â€” Virtual Nations Map</div>
        <div style="display:flex;gap:8px;align-items:center">
          <span id="priceBadge" class="badge">Grondprice: 50</span>
          <span id="balBadge" class="badge">ë³´ìœ  ì¬í™”: -</span>
          <button id="btnLogin" class="btn">ë¡œê·¸ì¸/íšŒì›ê°€ì…</button>
          <button id="btnLogout" class="btn" style="display:none;background:#334155">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

      <div class="row">
        <div class="left">
          <div class="panel">
            <h3>ì‹¤ì‹œê°„ í”½ì…€ ì˜í†  ë³´ë“œ (1000Ã—1500)</h3>

            <div class="toolbar">
              <div class="seg" id="modeSeg">
                <button data-mode="draw" class="active">ê·¸ë¦¬ê¸°</button>
                <button data-mode="pan">ì´ë™</button>
                <button data-mode="erase">ì§€ìš°ê°œ</button>
              </div>

              <label class="pill">
                <span class="hint">ìƒ‰ìƒ</span>
                <input id="color" type="color" value="#4ade80" style="background:transparent;border:0;width:48px;vertical-align:middle;margin-left:6px;cursor:pointer">
              </label>

              <label class="pill">
                <span class="hint">ë¸ŒëŸ¬ì‹œ</span>
                <select id="brush" style="background:transparent;border:0;margin-left:6px;cursor:pointer">
                  <option value="1">1ì…€</option>
                  <option value="2">2ì…€</option>
                  <option value="3">3ì…€</option>
                </select>
              </label>

              <div class="seg">
                <button id="zoomIn">í™•ëŒ€</button>
                <button id="zoomOut">ì¶•ì†Œ</button>
                <button id="zoomReset">ë§ì¶¤</button>
              </div>

              <span id="conn" class="status">ì—°ê²° ì¤‘â€¦</span>
            </div>

            <div class="canvas-wrap" id="canvasWrap">
              <canvas id="board" width="600" height="400"></canvas>
              <div id="nationList" class="nation-list" style="display:none">
                <div class="hint" style="margin-bottom:4px">ê±´êµ­ êµ­ê°€</div>
                <div id="nationItems"></div>
              </div>
            </div>

            <div class="toolbar" style="margin-top:12px">
              <button class="btn" id="btnExport" style="background:#1b6aa7">ë‚´ë³´ë‚´ê¸°(JSON)</button>
              <input id="fileImport" type="file" accept="application/json" style="display:none">
              <button class="btn" id="btnImport" style="background:#1b6aa7">ë¶ˆëŸ¬ì˜¤ê¸°</button>
              <button class="btn" id="btnClearLocal" style="background:#7c3aed">í™”ë©´ ì´ˆê¸°í™”(ë¡œì»¬)</button>
            </div>

            <div class="hint">Tip: ëª¨ë“œ=ì´ë™ì¼ ë•Œ ë“œë˜ê·¸ë¡œ íŒ¬, íœ ë¡œ ì¤Œ. ê·¸ë¦¬ê¸°/ì§€ìš°ê°œëŠ” ë“œë˜ê·¸í•˜ì—¬ ì¹ í•˜ì„¸ìš”.</div>
          </div>

          <div class="feed-card">
            <h3>ìƒˆ ê²Œì‹œë¬¼</h3>
            <input id="postTitle" class="input" placeholder="ì œëª© (ì˜ˆ: â—‹â—‹êµ­ í—Œë²• ì´ˆì•ˆ v1)">
            <textarea id="postBody" class="input" placeholder="ë‚´ìš© (ë©˜ì…˜: @êµ­ëª…)"></textarea>
            <div style="display:flex;gap:8px;margin-top:8px">
              <select id="postCategory" class="input" style="flex:0 0 140px">
                <option value="ë²•ë ¹">ë²•ë ¹</option>
                <option value="ì™¸êµ">ì™¸êµ</option>
                <option value="ì¼ë°˜" selected>ì¼ë°˜</option>
              </select>
              <button id="btnPublish" class="btn" style="flex:1;background:#16a34a">ê²Œì‹œ</button>
            </div>
            <div class="hint" style="margin-top:6px">@êµ­ëª… ìœ¼ë¡œ ë©˜ì…˜ ê°€ëŠ¥ Â· ë©˜ì…˜ ë°›ì€ ì‚¬ìš©ìëŠ” ì•Œë¦¼ì„ ë°›ìŠµë‹ˆë‹¤</div>
          </div>

          <div class="feed-card">
            <h3>íƒ€ì„ë¼ì¸</h3>
            <select id="filterCategory" class="input" style="max-width:200px">
              <option value="all">ì „ì²´</option>
              <option value="ë²•ë ¹">ë²•ë ¹</option>
              <option value="ì™¸êµ">ì™¸êµ</option>
              <option value="ì¼ë°˜">ì¼ë°˜</option>
            </select>
            <div id="feed" style="margin-top:12px;display:grid;gap:10px"></div>
          </div>
        </div>

        <div class="right">
          <div class="panel">
            <h3>ì˜í†  ì†ì„±</h3>
            <input id="projectName" class="input" placeholder="êµ­ê°€ëª… (ì˜ˆ: ë§ˆì´í¬ë¡œë„¤ì´ì…˜ ì—°ë§¹)">
            <div class="hint" style="margin-top:6px">í˜„ì¬ ë³´ë“œëŠ” ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ì‹¤ì‹œê°„ ê³µìœ ë©ë‹ˆë‹¤.</div>
          </div>

          <!-- âœ… ì—¬ê¸°ì— â€˜ì‹¤ì‹œê°„ ìœ ì € í–‰ì â€™ ë°°ì¹˜ -->
          <div class="panel">
            <h3>ì‹¤ì‹œê°„ í–‰ì </h3>
            <div id="activityList" class="mini-list"></div>
          </div>

          <!-- âœ… ê°„ë‹¨ ì•Œë¦¼ íŒ¨ë„ -->
          <div class="panel">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <h3>ë‚´ ì•Œë¦¼</h3>
              <button id="btnMarkRead" class="btn" style="background:#334155;padding:6px 10px">ëª¨ë‘ ì½ìŒ</button>
            </div>
            <div id="notifList" class="mini-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- êµ¬ë§¤ ëª¨ë‹¬ -->
  <div id="buyBack" class="modal-backdrop">
    <div class="modal">
      <h3>ì˜í†  êµ¬ë§¤</h3>
      <div id="buyDesc" class="hint">â€”</div>
      <div class="actions">
        <button id="btnBuyCancel" class="btn" style="background:#334155">ì·¨ì†Œ</button>
        <button id="btnBuyConfirm" class="btn" style="background:#16a34a">êµ¬ë§¤</button>
      </div>
    </div>
  </div>

  <!-- êµ­ê°€ ìƒ‰ìƒ ì„ íƒ ëª¨ë‹¬ -->
  <div id="colorBack" class="modal-backdrop">
    <div class="modal">
      <h3>êµ­ê°€ ì•„ì´ë´í‹°í‹° ìƒ‰ìƒ ì„ íƒ</h3>
      <div class="hint">íšŒì›ê°€ì… ì§í›„ 1íšŒ ì„¤ì •í•©ë‹ˆë‹¤. ì´ë¯¸ ì„ ì ëœ ìƒ‰ìƒì€ í”¼í•´ì£¼ì„¸ìš”.</div>
      <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
        <input type="color" id="identityColor" value="#22c55e" style="width:56px;height:34px;background:transparent;border:0">
        <input type="text" id="identityColorHex" class="input" placeholder="#RRGGBB" style="max-width:160px">
        <button id="btnColorSave" class="btn">ìƒ‰ìƒ í™•ì •</button>
      </div>
      <div class="hint" style="margin-top:6px">ì´ë¯¸ ì„ ì ëœ ìƒ‰ìƒ</div>
      <div id="takenColors" class="taken-list"></div>
    </div>
  </div>

  <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… ëª¨ë‹¬ -->
  <div id="authBack" class="modal-backdrop">
    <div class="modal">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3 style="margin-bottom:8px">ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h3>
        <button id="authClose" class="btn" style="background:#334155">ë‹«ê¸°</button>
      </div>

      <div class="seg" id="authModeSeg" style="margin-bottom:10px">
        <button data-auth="login" class="active">ë¡œê·¸ì¸</button>
        <button data-auth="signup">íšŒì›ê°€ì…</button>
      </div>

      <div id="authLoginForm">
        <input id="loginEmail" type="email" class="input" placeholder="ì´ë©”ì¼" autocomplete="email" style="margin-bottom:8px">
        <input id="loginPassword" type="password" class="input" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" autocomplete="current-password">
        <div class="actions">
          <button id="doLogin" class="btn" style="background:#16a34a">ë¡œê·¸ì¸</button>
        </div>
      </div>

      <div id="authSignupForm" style="display:none">
        <input id="signupEmail" type="email" class="input" placeholder="ì´ë©”ì¼" autocomplete="email" style="margin-bottom:8px">
        <input id="signupPassword" type="password" class="input" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" autocomplete="new-password" style="margin-bottom:8px">
        <input id="signupNation" type="text" class="input" placeholder="êµ­ëª… (ë‹‰ë„¤ì„)" autocomplete="organization">
        <div class="actions">
          <button id="doSignup" class="btn" style="background:#16a34a">íšŒì›ê°€ì…</button>
        </div>
      </div>
    </div>
  </div>

  <!-- êµ­ê¸°(í”„ë¡œí•„) ì—…ë¡œë“œ ëª¨ë‹¬ -->
  <div id="flagBack" class="modal-backdrop">
    <div class="modal">
      <h3>êµ­ê¸°(í”„ë¡œí•„) ì—…ë¡œë“œ</h3>
      <div class="hint">ì •ì‚¬ê°í˜• ì´ë¯¸ì§€ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤. PNG/JPG (ìµœëŒ€ 2MB)</div>
      <div style="display:flex;gap:12px;align-items:center;margin-top:10px">
        <img id="flagPreview" class="avatar" style="width:48px;height:48px;border-radius:8px" src="" alt="">
        <input id="flagFile" type="file" accept="image/*" />
      </div>
      <div class="actions">
        <button id="btnFlagSkip" class="btn" style="background:#334155">ê±´ë„ˆë›°ê¸°</button>
        <button id="btnFlagUpload" class="btn" style="background:#16a34a">ì—…ë¡œë“œ</button>
      </div>
    </div>
  </div>

<script type="module">
// ===== Firebase SDKs =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAnalytics, isSupported as analyticsSupported } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-analytics.js";
import {
  getAuth, onAuthStateChanged, signInWithEmailAndPassword,
  createUserWithEmailAndPassword, signOut, updateProfile,
  setPersistence, browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import {
  getFirestore, collection, doc, setDoc, deleteDoc, getDoc, getDocs,
  onSnapshot, serverTimestamp, writeBatch, query, orderBy, where, addDoc,
  runTransaction, limit
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import {
  getStorage, ref as sRef, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

// ===== ì‚¬ìš©ì ì œê³µ êµ¬ì„± =====
const firebaseConfig = {
  apiKey: "AIzaSyCYYBz3GLXmz8wJ3GzvGhQxHXN0Ht7enVI",
  authDomain: "canter-67ac7.firebaseapp.com",
  projectId: "canter-67ac7",
  storageBucket: "canter-67ac7.firebasestorage.app",
  messagingSenderId: "674361186252",
  appId: "1:674361186252:web:628989bdbc1591a610ef69",
  measurementId: "G-W6CMCZGBC5"
};
const app = initializeApp(firebaseConfig);
try { analyticsSupported().then((ok)=>{ if (ok) getAnalytics(app); }); } catch {}

const auth = getAuth(app);
await setPersistence(auth, browserLocalPersistence);
const db = getFirestore(app);
// âœ… ì‹¤ì œ ê¸°ë³¸ ë²„í‚·ìœ¼ë¡œ ê°•ì œ ì‚¬ìš©(ì—…ë¡œë“œ ì˜¤ë¥˜ ë°©ì§€):
const storage = getStorage(app, `gs://${firebaseConfig.projectId}.appspot.com`);

// ===== ê°€ê²©/ì„¤ì • =====
let grondPrice = 50;
const priceBadge = document.getElementById('priceBadge');
const settingsRef = doc(db, 'settings', 'global');
(async ()=>{
  try{
    const s = await getDoc(settingsRef);
    if (s.exists() && typeof s.data().grondPrice === 'number'){
      grondPrice = s.data().grondPrice;
      priceBadge.textContent = `Grondprice: ${grondPrice}`;
    } else {
      await setDoc(settingsRef, { grondPrice: grondPrice }, { merge: true });
    }
  }catch(e){ console.warn('settings load failed', e); }
})();

// ===== DOM =====
const btnLogin = document.getElementById('btnLogin');
const btnLogout = document.getElementById('btnLogout');
const conn = document.getElementById('conn');
const canvas = document.getElementById('board');
const ctx = canvas.getContext('2d');
const modeSeg = document.getElementById('modeSeg');
const colorEl = document.getElementById('color');
const brushEl = document.getElementById('brush');
const zoomIn = document.getElementById('zoomIn');
const zoomOut = document.getElementById('zoomOut');
const zoomReset = document.getElementById('zoomReset');
const btnExport = document.getElementById('btnExport');
const btnImport = document.getElementById('btnImport');
const fileImport = document.getElementById('fileImport');
const btnClearLocal = document.getElementById('btnClearLocal');
const balBadge = document.getElementById('balBadge');
const projectNameEl = document.getElementById('projectName');
const nationListBox = document.getElementById('nationList');
const nationItems = document.getElementById('nationItems');

// êµ¬ë§¤ ëª¨ë‹¬
const buyBack = document.getElementById('buyBack');
const buyDesc = document.getElementById('buyDesc');
const btnBuyCancel = document.getElementById('btnBuyCancel');
const btnBuyConfirm = document.getElementById('btnBuyConfirm');

// ìƒ‰ìƒ ì„ íƒ ëª¨ë‹¬
const colorBack = document.getElementById('colorBack');
const identityColor = document.getElementById('identityColor');
const identityColorHex = document.getElementById('identityColorHex');
const takenColors = document.getElementById('takenColors');
const btnColorSave = document.getElementById('btnColorSave');

// ì¸ì¦ ëª¨ë‹¬
const authBack = document.getElementById('authBack');
const authClose = document.getElementById('authClose');
const authModeSeg = document.getElementById('authModeSeg');
const authLoginForm = document.getElementById('authLoginForm');
const authSignupForm = document.getElementById('authSignupForm');
const loginEmail = document.getElementById('loginEmail');
const loginPassword = document.getElementById('loginPassword');
const signupEmail = document.getElementById('signupEmail');
const signupPassword = document.getElementById('signupPassword');
const signupNation = document.getElementById('signupNation');
const doLogin = document.getElementById('doLogin');
const doSignup = document.getElementById('doSignup');

// êµ­ê¸° ì—…ë¡œë“œ ëª¨ë‹¬
const flagBack = document.getElementById('flagBack');
const flagPreview = document.getElementById('flagPreview');
const flagFile = document.getElementById('flagFile');
const btnFlagUpload = document.getElementById('btnFlagUpload');
const btnFlagSkip = document.getElementById('btnFlagSkip');

// ìš°ì¸¡ íŒ¨ë„: í–‰ì /ì•Œë¦¼
const activityList = document.getElementById('activityList');
const notifList = document.getElementById('notifList');
const btnMarkRead = document.getElementById('btnMarkRead');

// ===== ë³´ë“œ ì„¤ì • =====
const BOARD_W = 1500, BOARD_H = 1000;
const CELL = 10; // 10px ê·¸ë¦¬ë“œ
const COLS = BOARD_W / CELL; // 150
const ROWS = BOARD_H / CELL; // 100

// ë·°(íŒ¬/ì¤Œ)
let scale = 1;
let offsetX = 0, offsetY = 0;
let isPanning = false, panStart = {x:0,y:0}, viewStart = {x:0,y:0};
let didFirstFit = false;

// ìƒíƒœ
let mode = 'draw'; // draw | erase | pan
let drawing = false;
let lastCellKey = null;
const pixels = new Map(); // "x_y" -> {x,y,color,ownerUid,nationName}
let preStrokeKeys = null;
let pendingNew = new Map();    // ìƒˆë¡œ ì¹ í•´ì§„ ì…€ë“¤
let pendingDelete = new Map(); // ë³¸ì¸ ë•… ì‚­ì œ

// ìœ ì €/êµ­ê°€
let me = null;
let myProfile = null;
let nations = new Map();

// ===== ë„ìš°ë¯¸ =====
function worldToScreen(x, y) { return { x: x*scale + offsetX, y: y*scale + offsetY }; }
function screenToWorld(x, y) { return { x: (x - offsetX) / scale, y: (y - offsetY) / scale }; }
function clamp(v,a,b){return Math.max(a, Math.min(b,v));}
function fitInitial() {
  const w = canvas.clientWidth, h = canvas.clientHeight;
  const sx = w / BOARD_W, sy = h / BOARD_H;
  scale = Math.min(sx, sy);
  const viewW = BOARD_W*scale, viewH = BOARD_H*scale;
  offsetX = (w - viewW)/2;
  offsetY = (h - viewH)/2;
  render();
}
function resizeCanvas() {
  const rect = canvas.getBoundingClientRect();
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  canvas.width = Math.floor(rect.width * dpr);
  canvas.height = Math.floor(rect.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  if (!didFirstFit) { fitInitial(); didFirstFit = true; } else { render(); }
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// ===== ë Œë”ë§ =====
function render() {
  const w = canvas.clientWidth, h = canvas.clientHeight;
  ctx.clearRect(0,0,w,h);

  // ë³´ë“œ
  ctx.save();
  ctx.translate(offsetX, offsetY);
  ctx.scale(scale, scale);

  ctx.fillStyle = "#0a0f1e";
  ctx.fillRect(0,0,BOARD_W,BOARD_H);

  // ê·¸ë¦¬ë“œ
  ctx.beginPath();
  ctx.lineWidth = 0.25/scale;
  ctx.strokeStyle = "rgba(255,255,255,0.06)";
  for (let x=0; x<=COLS; x++){ const gx=x*CELL; ctx.moveTo(gx,0); ctx.lineTo(gx,BOARD_H); }
  for (let y=0; y<=ROWS; y++){ const gy=y*CELL; ctx.moveTo(0,gy); ctx.lineTo(BOARD_W,gy); }
  ctx.stroke();

  // í”½ì…€
  for (const v of pixels.values()){
    ctx.fillStyle = v.color;
    ctx.fillRect(v.x*CELL, v.y*CELL, CELL, CELL);
  }
  ctx.restore();
}

// ===== ì…ë ¥ ì²˜ë¦¬ =====
modeSeg.addEventListener('click', (e)=>{
  if (e.target.tagName !== 'BUTTON') return;
  for (const b of modeSeg.querySelectorAll('button')) b.classList.remove('active');
  e.target.classList.add('active');
  mode = e.target.dataset.mode;
});

canvas.addEventListener('pointerdown', (e)=>{
  canvas.setPointerCapture(e.pointerId);
  const {x,y} = screenToWorld(e.offsetX, e.offsetY);
  if (mode === 'pan'){
    isPanning = true; panStart = {x:e.clientX,y:e.clientY}; viewStart={x:offsetX,y:offsetY}; return;
  }
  drawing = true;
  lastCellKey = null;
  preStrokeKeys = new Set(pixels.keys());
  pendingNew.clear();
  pendingDelete.clear();
  paintAt(x,y);
});

canvas.addEventListener('pointermove', (e)=>{
  const {x,y} = screenToWorld(e.offsetX, e.offsetY);
  if (mode === 'pan' && isPanning){ offsetX = viewStart.x + (e.clientX-panStart.x); offsetY = viewStart.y + (e.clientY-panStart.y); render(); return; }
  if (!drawing) return;
  paintAt(x,y);
});

canvas.addEventListener('pointerup', async (e)=>{
  canvas.releasePointerCapture(e.pointerId);
  if (mode === 'pan'){ isPanning = false; return; }
  if (!drawing) return;
  drawing = false;

  const needBuy = pendingNew.size;
  if (needBuy > 0){
    const cost = needBuy * grondPrice;
    showBuyModal(needBuy, cost, async ()=>{
      const ok = await chargeAndCommit(cost, pendingNew, pendingDelete);
      if (!ok){
        for(const [k] of pendingNew) pixels.delete(k);
        render();
        alert('ì”ì•¡ ë¶€ì¡± ë˜ëŠ” ì˜¤ë¥˜ë¡œ êµ¬ë§¤ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    }, ()=>{
      for(const [k] of pendingNew) pixels.delete(k);
      render();
    });
  } else {
    if (pendingDelete.size>0) await commitDeletes(pendingDelete);
  }
});

canvas.addEventListener('wheel', (e)=>{
  e.preventDefault();
  const mx = e.offsetX, my = e.offsetY;
  const pre = screenToWorld(mx,my);
  const factor = Math.exp(-e.deltaY * 0.0015);
  scale = clamp(scale * factor, 0.2, 8);
  const post = worldToScreen(pre.x, pre.y);
  offsetX += (mx - post.x); offsetY += (my - post.y);
  render();
},{passive:false});

function paintAt(wx, wy){
  const bx = Math.floor(clamp(wx,0,BOARD_W-1) / CELL);
  const by = Math.floor(clamp(wy,0,BOARD_H-1) / CELL);
  const size = parseInt(brushEl.value,10);
  for(let iy=0; iy<size; iy++){
    for(let ix=0; ix<size; ix++){
      const cx = bx+ix, cy = by+iy;
      if (cx<0||cy<0||cx>=COLS||cy>=ROWS) continue;
      const key = `${cx}_${cy}`;
      if (mode === 'erase'){
        const cur = pixels.get(key);
        if (cur && cur.ownerUid === me?.uid){
          pixels.delete(key);
          pendingDelete.set(key, {x:cx,y:cy});
        }
        continue;
      }
      if (pixels.has(key)) continue;
      const col = myProfile?.color || colorEl.value;
      pixels.set(key, {x:cx, y:cy, color: col, ownerUid: me?.uid || null, nationName: myProfile?.nationName || (projectNameEl.value||'')});
      pendingNew.set(key, {x:cx, y:cy});
    }
  }
  render();
}

// ===== êµ¬ë§¤ & ì»¤ë°‹ =====
function showBuyModal(count, cost, onConfirm, onCancel){
  buyDesc.textContent = `ì´ë²ˆì— ê·¸ë¦° ìƒˆ í”½ì…€: ${count}ê°œ Ã— ${grondPrice} = ì´ ${cost}`;
  buyBack.style.display = 'flex';
  const off = ()=>{
    buyBack.style.display = 'none';
    btnBuyConfirm.removeEventListener('click', yes);
    btnBuyCancel.removeEventListener('click', no);
  };
  const yes = ()=>{ off(); onConfirm&&onConfirm(); };
  const no  = ()=>{ off(); onCancel&&onCancel(); };
  btnBuyConfirm.addEventListener('click', yes);
  btnBuyCancel.addEventListener('click', no);
}

async function chargeAndCommit(cost, newCells, delCells){
  if (!me){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return false; }
  try{
    const userRef = doc(db, 'users', me.uid);
    let newBalance = 0;
    await runTransaction(db, async (tx)=>{
      const snap = await tx.get(userRef);
      const cur = snap.exists() ? snap.data() : {};
      const bal = cur.balance ?? 0;
      if (bal < cost) throw new Error('INSUFFICIENT');
      newBalance = bal - cost;
      tx.set(userRef, { balance: newBalance }, { merge: true });
    });
    const wb = writeBatch(db);
    const ref = collection(db, 'pixels');
    const nowNation = myProfile?.nationName || (projectNameEl.value||'');
    const nowColor = myProfile?.color || colorEl.value;
    for (const [key, v] of newCells){
      const d = doc(ref, key);
      wb.set(d, {
        x:v.x, y:v.y, color: nowColor,
        ownerUid: me.uid,
        ownerName: me.displayName || myProfile?.nationName || me.email,
        nationName: nowNation,
        updatedAt: serverTimestamp()
      }, {merge:false});
    }
    for (const [key, v] of delCells){
      const d = doc(ref, key);
      wb.delete(d);
    }
    await wb.commit();
    balBadge.textContent = `ë³´ìœ  ì¬í™”: ${newBalance}`;
    // âœ… ì‹¤ì‹œê°„ í–‰ì  ê¸°ë¡
    if (newCells.size>0){
      await addDoc(collection(db,'activities'), {
        type:'expand', uid: me.uid, nationName: nowNation, color: nowColor,
        count: newCells.size, createdAt: serverTimestamp()
      });
    }
    pendingNew.clear(); pendingDelete.clear();
    return true;
  }catch(e){
    console.error(e);
    return false;
  }
}
async function commitDeletes(delCells){
  try{
    const wb = writeBatch(db);
    const ref = collection(db, 'pixels');
    for (const [key, v] of delCells) wb.delete(doc(ref, key));
    await wb.commit();
    pendingDelete.clear();
  }catch(e){ console.error(e); }
}

// ===== ì‹¤ì‹œê°„ êµ¬ë… =====
const pixelsRef = collection(db, 'pixels');
onSnapshot(pixelsRef, (snap)=>{
  snap.docChanges().forEach(ch=>{
    const id = ch.doc.id;
    if (ch.type === 'removed'){ pixels.delete(id); }
    else {
      const v = ch.doc.data();
      pixels.set(id, {x:v.x,y:v.y,color:v.color,ownerUid:v.ownerUid||null,nationName:v.nationName||''});
    }
  });
  conn.textContent = 'ì‹¤ì‹œê°„ ì—°ê²°ë¨';
  render();
}, (err)=>{ console.error(err); conn.textContent='ì—°ê²° ì˜¤ë¥˜'; });

// ===== ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸°/ì´ˆê¸°í™” =====
document.getElementById('btnExport').addEventListener('click', ()=>{
  const arr = [...pixels.values()];
  const blob = new Blob([JSON.stringify(arr)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download='pixels.json'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('btnImport').addEventListener('click', ()=> fileImport.click());
fileImport.addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  let arr; try{ arr=JSON.parse(await f.text()); }catch{ alert('JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.'); return; }
  const wb=writeBatch(db); const ref=collection(db,'pixels');
  const nowNation = myProfile?.nationName || (projectNameEl.value||'');
  const nowColor = myProfile?.color || colorEl.value;
  arr.forEach(v=>{
    const d=doc(ref,`${v.x}_${v.y}`);
    wb.set(d,{x:v.x,y:v.y,color:nowColor,ownerUid:me?.uid||null,ownerName:me?.displayName||me?.email||'',nationName:nowNation,updatedAt:serverTimestamp()},{merge:true});
    pixels.set(`${v.x}_${v.y}`,{x:v.x,y:v.y,color:nowColor,ownerUid:me?.uid||null,nationName:nowNation});
  });
  await wb.commit(); render(); alert('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ'); e.target.value='';
});
document.getElementById('btnClearLocal').addEventListener('click', ()=>{
  if (!confirm('í™”ë©´ì˜ í”½ì…€ í‘œì‹œë§Œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. (ì„œë²„ ë°ì´í„°ëŠ” ìœ ì§€)')) return;
  pixels.clear(); render();
});

// ===== ì¸ì¦ & í”„ë¡œí•„(ì”ì•¡/ìƒ‰ìƒ/êµ­ê°€ëª…/êµ­ê¸°) =====
const usersRef = (uid)=>doc(db,'users',uid);
const nationsRef = (uid)=>doc(db,'nations',uid);

async function ensureUserDoc(u){
  const ur = usersRef(u.uid);
  const snap = await getDoc(ur);
  if (!snap.exists()){
    const initBal = grondPrice * 10; // ê°€ì… ì´ˆê¸° 10í”½ì…€ë¶„
    await setDoc(ur,{ balance:initBal, color:null, nationName:(projectNameEl.value||''), photoURL:null },{merge:true});
  }
  myProfile = (await getDoc(ur)).data() || {};
  balBadge.textContent = `ë³´ìœ  ì¬í™”: ${myProfile.balance ?? 0}`;

  if (myProfile.nationName) projectNameEl.value = myProfile.nationName;
  projectNameEl.addEventListener('change', async ()=>{
    myProfile.nationName = projectNameEl.value.trim();
    await setDoc(ur,{ nationName: myProfile.nationName },{merge:true});
    if (myProfile.color) await setDoc(nationsRef(u.uid), { name: myProfile.nationName, color: myProfile.color }, { merge:true });
  });

  if (!myProfile.color) openColorModal();
  else colorEl.value = myProfile.color;

  // ì•Œë¦¼ êµ¬ë… ì‹œì‘
  subscribeNotifications(u.uid);
}

function openColorModal(){
  colorBack.style.display='flex';
  identityColorHex.value = myProfile?.color || identityColor.value;
}
btnColorSave.addEventListener('click', async ()=>{
  if (!me) return;
  const hex = (identityColorHex.value || identityColor.value || '').trim();
  if (!/^#([0-9a-fA-F]{6})$/.test(hex)){ alert('ìƒ‰ìƒ í˜•ì‹ì€ #RRGGBB ì…ë‹ˆë‹¤.'); return; }
  for(const n of nations.values()){
    if ((n.color||'').toLowerCase() === hex.toLowerCase()){
      alert('ì´ë¯¸ ì„ ì ëœ ìƒ‰ìƒì…ë‹ˆë‹¤. ë‹¤ë¥¸ ìƒ‰ì„ ì„ íƒí•˜ì„¸ìš”.'); return;
    }
  }
  const name = (projectNameEl.value||myProfile?.nationName||me.displayName||me.email||'ë¬´ëª…êµ­').toString();
  await setDoc(usersRef(me.uid), { color: hex, nationName: name }, { merge:true });
  await setDoc(nationsRef(me.uid), { name, color: hex }, { merge:true });
  myProfile = (await getDoc(usersRef(me.uid))).data();
  colorEl.value = myProfile.color;
  colorBack.style.display='none';

  // ìƒ‰ìƒ ì„ íƒ ì™„ë£Œ í›„, êµ­ê¸° ì—…ë¡œë“œ ëª¨ë‹¬ ì˜¤í”ˆ
  openFlagModal();
});

identityColor.addEventListener('input', ()=> identityColorHex.value = identityColor.value);
identityColorHex.addEventListener('input', ()=> {
  const v = identityColorHex.value.trim();
  if (/^#([0-9a-fA-F]{6})$/.test(v)) identityColor.value = v;
});

onSnapshot(collection(db,'nations'), (snap)=>{
  nations.clear();
  snap.forEach(d=>nations.set(d.id, d.data()));
  const rows = [];
  snap.forEach(d=>{
    const n = d.data();
    rows.push(`<div class="nation-row"><span class="swatch" style="background:${n.color||'#999'}"></span><span>${n.name||'(ë¬´ëª…êµ­)'}</span></div>`);
  });
  nationItems.innerHTML = rows.join('') || '<div class="hint">ì•„ì§ ê±´êµ­ëœ êµ­ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
  nationListBox.style.display = 'block';

  takenColors.innerHTML = rows.join('') || '<div class="hint">ì—†ìŒ</div>';
});

// ë¡œê·¸ì¸/íšŒì›ê°€ì… ëª¨ë‹¬ í† ê¸€ & ë™ì‘
function openAuthModal(mode='login'){
  authBack.style.display='flex';
  setAuthMode(mode);
}
function closeAuthModal(){ authBack.style.display='none'; }
function setAuthMode(mode){
  const btns = authModeSeg.querySelectorAll('button');
  btns.forEach(b=>b.classList.remove('active'));
  const target = [...btns].find(b=>b.dataset.auth===mode);
  if (target) target.classList.add('active');
  if (mode==='login'){ authLoginForm.style.display='block'; authSignupForm.style.display='none'; }
  else { authLoginForm.style.display='none'; authSignupForm.style.display='block'; }
}

btnLogin.addEventListener('click', ()=> openAuthModal('login'));
btnLogout.addEventListener('click', ()=> signOut(auth));
authClose.addEventListener('click', closeAuthModal);
authBack.addEventListener('click', (e)=>{ if (e.target===authBack) closeAuthModal(); });
authModeSeg.addEventListener('click', (e)=>{
  if (e.target.tagName!=='BUTTON') return;
  setAuthMode(e.target.dataset.auth);
});

doLogin.addEventListener('click', async ()=>{
  const email = (loginEmail.value||'').trim();
  const pass = loginPassword.value||'';
  if (!email || !pass) { alert('ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  try{
    await signInWithEmailAndPassword(auth, email, pass);
    closeAuthModal();
    alert('ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
  }catch(e){
    alert('ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + (e.message||e.code));
  }
});
doSignup.addEventListener('click', async ()=>{
  const email = (signupEmail.value||'').trim();
  const pass = signupPassword.value||'';
  const nation = (signupNation.value||'').trim();
  if (!email || !pass || !nation) { alert('ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸/êµ­ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  try{
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    await updateProfile(cred.user, {displayName: nation});
    const initBal = grondPrice * 10;
    await setDoc(usersRef(cred.user.uid), { balance: initBal, nationName: nation, color: null, photoURL: null }, { merge:true });
    await setDoc(nationsRef(cred.user.uid), { name: nation }, { merge:true });

    projectNameEl.value = nation;
    myProfile = (await getDoc(usersRef(cred.user.uid))).data();

    closeAuthModal();
    alert('ê°€ì… ì™„ë£Œ. ìƒ‰ìƒ/êµ­ê¸° ì„¤ì •ì„ ì§„í–‰í•˜ì„¸ìš”.');
    openColorModal();
  }catch(e){
    alert('ê°€ì… ì˜¤ë¥˜: ' + (e.message||e.code));
  }
});

// ì¸ì¦ ìƒíƒœ ê´€ì°°
onAuthStateChanged(auth, async (user)=>{
  me = user || null;
  if (user){
    btnLogin.style.display='none'; btnLogout.style.display='';
    await ensureUserDoc(user);
  }else{
    btnLogin.style.display=''; btnLogout.style.display='none';
    balBadge.textContent = 'ë³´ìœ  ì¬í™”: -';
    notifList.innerHTML = '<div class="hint">ë¡œê·¸ì¸í•˜ë©´ ì•Œë¦¼ì„ ë³¼ ìˆ˜ ìˆì–´ìš”</div>';
  }
});

// ===== êµ­ê¸° ì—…ë¡œë“œ (ë²„íŠ¼ ë°˜ì‘ ì—†ìŒ ë²„ê·¸ ëŒ€ì‘: ë¡œë”©/ë””ìŠ¤ì—ì´ë¸”/ì •í™• ë²„í‚·) =====
function openFlagModal(){
  flagPreview.src = myProfile?.photoURL || '';
  flagFile.value = '';
  flagBack.style.display = 'flex';
}
function closeFlagModal(){
  flagBack.style.display = 'none';
}
flagFile.addEventListener('change', ()=>{
  const f = flagFile.files?.[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  flagPreview.src = url;
});

btnFlagSkip.addEventListener('click', ()=> closeFlagModal());

btnFlagUpload.addEventListener('click', async ()=>{
  if (!me){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
  const f = flagFile.files?.[0];
  if (!f){ alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }

  // ğŸ”§ ì—…ë¡œë“œ ì¤‘ UI ì ê¸ˆ(ë²„íŠ¼ ë¹„í™œì„±/í…ìŠ¤íŠ¸ ë³€ê²½)
  const prevText = btnFlagUpload.textContent;
  btnFlagUpload.disabled = true;
  btnFlagUpload.textContent = 'ì—…ë¡œë“œ ì¤‘â€¦';

  try{
    if (f.size > 2*1024*1024) throw new Error('2MB ì´í•˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    const path = `flags/${me.uid}_${Date.now()}`;
    const ref = sRef(storage, path);
    await uploadBytes(ref, f, { contentType: f.type || 'image/png' });
    const url = await getDownloadURL(ref);

    await setDoc(usersRef(me.uid), { photoURL: url }, { merge:true });
    await setDoc(nationsRef(me.uid), { flagURL: url }, { merge:true });
    await updateProfile(me, { photoURL: url });

    myProfile = (await getDoc(usersRef(me.uid))).data();
    // âœ… ì—…ë¡œë“œ ì™„ë£Œ í›„ ëª¨ë‹¬ ë‹«ê¸° & ì•ˆë‚´
    closeFlagModal();
    alert('êµ­ê¸°(í”„ë¡œí•„) ì—…ë¡œë“œ ì™„ë£Œ!');
  }catch(e){
    console.error(e);
    alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (e.message || e.code || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
  }finally{
    btnFlagUpload.disabled = false;
    btnFlagUpload.textContent = prevText;
  }
});

// ===== ì»¤ë®¤ë‹ˆí‹°: ê²Œì‹œ & í”¼ë“œ(+ì‘ì„±ì êµ­ëª…/êµ­ê¸°, ëŒ“ê¸€, ì•Œë¦¼/ë©˜ì…˜) =====
const postsRef = collection(db, 'posts');
const postTitle = document.getElementById('postTitle');
const postBody = document.getElementById('postBody');
const postCategory = document.getElementById('postCategory');

const postMeta = new Map(); // postId -> {authorUid, title}

function parseMentions(text){
  const set = new Set();
  const re = /@([\p{L}\p{N}_\-]{1,32})/gu; // í•œê¸€/ì˜ë¬¸/ìˆ«ì/ì–¸ë”ìŠ¤ì½”ì–´/í•˜ì´í”ˆ
  let m; while((m = re.exec(text))){ set.add(m[1]); }
  return [...set];
}

async function notifyUser(uid, payload){
  try{
    await addDoc(collection(db, `users/${uid}/notifications`), {
      ...payload,
      read: false,
      createdAt: serverTimestamp()
    });
  }catch(e){ console.warn('notify fail', e); }
}

async function notifyMentions(mentions, payloadBase){
  // ë©˜ì…˜ëœ êµ­ëª… -> nations ì»¬ë ‰ì…˜ì—ì„œ name ë§¤ì¹­
  for (const name of mentions){
    try{
      const snap = await getDocs(query(collection(db,'nations'), where('name','==',name)));
      snap.forEach(docu=>{
        const targetUid = docu.id;
        if (me && targetUid === me.uid) return; // ìê¸° ìì‹  ë©˜ì…˜ì€ ë¬´ì‹œ
        notifyUser(targetUid, { type:'mention', ...payloadBase, message:`${payloadBase.actorNation} ë‹˜ì´ ë‹¹ì‹ ì„ ë©˜ì…˜í–ˆìŠµë‹ˆë‹¤.` });
      });
    }catch(e){ console.warn('mention query fail', e); }
  }
}

document.getElementById('btnPublish').addEventListener('click', async ()=>{
  const user = auth.currentUser;
  if (!user){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
  const title = (postTitle.value||'').trim();
  const body = (postBody.value||'').trim();
  const category = postCategory.value;
  if (!title || !body){ alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const authorNation = myProfile?.nationName || user.displayName || user.email;
  const authorPhoto = myProfile?.photoURL || user.photoURL || null;

  const ref = await addDoc(postsRef, {
    title, body, category,
    authorUid: user.uid,
    authorNationName: authorNation,
    authorPhotoURL: authorPhoto,
    createdAt: serverTimestamp()
  });

  // âœ… ê²Œì‹œê¸€ ë³¸ë¬¸ ë©˜ì…˜ ì•Œë¦¼
  const mentions = parseMentions(`${title}\n${body}`);
  await notifyMentions(mentions, { type:'mention_post', postId: ref.id, actorUid: user.uid, actorNation: authorNation, preview: title });

  postTitle.value=''; postBody.value='';
  alert('ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.');
});

const feed = document.getElementById('feed');
const filterCategory = document.getElementById('filterCategory');

function formatDate(ts){
  try{
    const d = ts?.toDate?.() ? ts.toDate() : (ts instanceof Date ? ts : new Date());
    return d.toLocaleString();
  }catch{ return new Date().toLocaleString(); }
}

function renderPostCard(id, p){
  const el = document.createElement('article');
  el.className = 'panel';
  const avatar = p.authorPhotoURL || '';
  const nation = p.authorNationName || '(ë¬´ëª…êµ­)';

  el.innerHTML = `
    <div class="post-header">
      <img class="avatar" src="${avatar || ''}" alt="" onerror="this.style.display='none'">
      <div style="font-weight:800">${p.title || '(ì œëª© ì—†ìŒ)'}
        <span class="hint" style="margin-left:8px">by ${nation}</span>
      </div>
      <div class="hint" style="margin-left:auto">${formatDate(p.createdAt)}</div>
    </div>
    <div class="hint" style="margin-bottom:8px">ì¹´í…Œê³ ë¦¬: ${p.category}</div>
    <div style="white-space:pre-wrap">${p.body || ''}</div>

    <!-- ëŒ“ê¸€ UI -->
    <div id="cmt-list-${id}" style="margin-top:10px"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="cmt-input-${id}" class="input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš” (ë©˜ì…˜: @êµ­ëª…)" />
      <button id="cmt-send-${id}" class="btn" style="flex:0 0 auto;background:#2563eb">ëŒ“ê¸€</button>
    </div>
  `;
  // ë©”íƒ€ ì €ì¥(ëŒ“ê¸€ ì•Œë¦¼ ìš©)
  postMeta.set(id, { authorUid: p.authorUid, title: p.title, authorNation: p.authorNationName });
  // ëŒ“ê¸€ ì´ë²¤íŠ¸ ë°”ì¸ë”©
  setTimeout(()=> attachCommentHandlers(id), 0);
  return el;
}

const commentUnsubs = new Map();
function attachCommentHandlers(postId){
  const input = document.getElementById(`cmt-input-${postId}`);
  const sendBtn = document.getElementById(`cmt-send-${postId}`);
  const listBox = document.getElementById(`cmt-list-${postId}`);
  if (!input || !sendBtn || !listBox) return;

  if (commentUnsubs.has(postId)){ commentUnsubs.get(postId)(); commentUnsubs.delete(postId); }

  sendBtn.addEventListener('click', async ()=>{
    const user = auth.currentUser;
    if (!user){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
    const text = (input.value||'').trim();
    if (!text) return;
    const authorNation = myProfile?.nationName || user.displayName || user.email;
    const authorPhoto = myProfile?.photoURL || user.photoURL || null;
    const cRef = await addDoc(collection(db, `posts/${postId}/comments`), {
      text, authorUid: user.uid,
      authorNationName: authorNation,
      authorPhotoURL: authorPhoto,
      createdAt: serverTimestamp()
    });
    input.value='';

    // âœ… ëŒ“ê¸€ ì•Œë¦¼(ê²Œì‹œê¸€ ì‘ì„±ì)
    const meta = postMeta.get(postId);
    if (meta?.authorUid && meta.authorUid !== user.uid){
      await notifyUser(meta.authorUid, {
        type:'comment',
        postId: postId,
        commentId: cRef.id,
        actorUid: user.uid,
        actorNation: authorNation,
        message:`${authorNation} ë‹˜ì´ ëŒ“ê¸€ì„ ë‚¨ê²¼ìŠµë‹ˆë‹¤.`,
        preview: text.slice(0,80)
      });
    }
    // âœ… ëŒ“ê¸€ ë©˜ì…˜ ì•Œë¦¼
    const mentions = parseMentions(text);
    await notifyMentions(mentions, {
      type:'mention_comment',
      postId: postId,
      commentId: cRef.id,
      actorUid: user.uid,
      actorNation: authorNation,
      preview: text.slice(0,80)
    });
  });

  const qRef = query(collection(db, `posts/${postId}/comments`), orderBy('createdAt','asc'));
  const unsub = onSnapshot(qRef, (snap)=>{
    listBox.innerHTML = '';
    snap.forEach(d=>{
      const c = d.data();
      const li = document.createElement('div');
      li.className = 'cmt-item';
      li.innerHTML = `
        <img class="avatar" src="${c.authorPhotoURL || ''}" alt="" onerror="this.style.display='none'">
        <div style="flex:1">
          <div class="hint" style="margin-bottom:2px">${c.authorNationName || '(ìµëª…)'} Â· ${formatDate(c.createdAt)}</div>
          <div style="white-space:pre-wrap">${c.text || ''}</div>
        </div>
      `;
      listBox.appendChild(li);
    });
  });
  commentUnsubs.set(postId, unsub);
}

let unsubscribeFeed = null;
function loadFeed(cat='all'){
  if (unsubscribeFeed) unsubscribeFeed();
  commentUnsubs.forEach(fn=>fn()); commentUnsubs.clear();

  let qRef = query(postsRef, orderBy('createdAt','desc'));
  if (cat !== 'all'){ qRef = query(postsRef, where('category','==',cat), orderBy('createdAt','desc')); }
  unsubscribeFeed = onSnapshot(qRef, (snap)=>{
    feed.innerHTML = '';
    snap.forEach(docu => feed.appendChild(renderPostCard(docu.id, docu.data())));
  });
}
filterCategory.addEventListener('change', ()=> loadFeed(filterCategory.value));
loadFeed();

// ===== ì‹¤ì‹œê°„ í–‰ì  í‘œì‹œ =====
onSnapshot(query(collection(db,'activities'), orderBy('createdAt','desc'), limit(30)), (snap)=>{
  activityList.innerHTML = '';
  snap.forEach(d=>{
    const a = d.data();
    if (a.type==='expand'){
      const div = document.createElement('div');
      div.className='mini-item';
      div.innerHTML = `<div><b>${a.nationName || '(ë¬´ëª…êµ­)'}</b> ë‹˜ì´ <b>${a.count}</b> í”½ì…€ì„ í™•ì¥í•˜ì˜€ìŠµë‹ˆë‹¤.</div>
                       <div class="hint">${formatDate(a.createdAt)}</div>`;
      activityList.appendChild(div);
    }
  });
});

// ===== ì•Œë¦¼ êµ¬ë… & ëª¨ë‘ ì½ìŒ =====
let unsubNotif = null;
function subscribeNotifications(uid){
  if (unsubNotif) unsubNotif();
  const qRef = query(collection(db, `users/${uid}/notifications`), orderBy('createdAt','desc'), limit(30));
  unsubNotif = onSnapshot(qRef, (snap)=>{
    notifList.innerHTML = '';
    if (snap.empty){
      notifList.innerHTML = '<div class="hint">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }
    snap.forEach(d=>{
      const n = d.data();
      const div = document.createElement('div');
      div.className = 'mini-item';
      const readMark = n.read ? '' : ' <span class="badge" style="margin-left:6px">NEW</span>';
      const message = n.message || (n.type==='mention'?'ë©˜ì…˜ ì•Œë¦¼':'ì•Œë¦¼');
      const preview = n.preview ? `<div class="hint" style="margin-top:4px">${n.preview}</div>` : '';
      div.innerHTML = `<div>${message}${readMark}</div>${preview}<div class="hint">${formatDate(n.createdAt)}</div>`;
      notifList.appendChild(div);
    });
  }, (err)=>{
    console.warn('notif subscribe error', err);
    notifList.innerHTML = '<div class="hint">ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
  });
}

btnMarkRead.addEventListener('click', async ()=>{
  if (!me) return;
  try{
    const qRef = query(collection(db, `users/${me.uid}/notifications`), where('read','==',false), limit(50));
    const s = await getDocs(qRef);
    const wb = writeBatch(db);
    s.forEach(docu=> wb.set(doc(db, `users/${me.uid}/notifications/${docu.id}`), { read:true }, { merge:true }));
    await wb.commit();
  }catch(e){ console.warn('mark read fail', e); }
});
</script>
</body>
</html>
